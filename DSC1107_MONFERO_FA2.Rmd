---
title: "DSC1107_MONFERO_FA2"
author: "John Benedict A. Monfero"
date: "2025-02-13"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
### In this formative assessment, you will review Unit 1, focusing on data wrangling, manipulation, and visualization.

```{r required_libraries}
library(tidyverse)
```

You will perform a data analysis to study trends in tuberculosis (TB) cases worldwide over time. The two relevant datasets are:

+ `who.tsv`: Information about TB cases in various countries from 1980 to 2013 (Source: 2014 WHO Global Tuberculosis Report).
```{r}
# A subset of data from the World Health Organization Global Tuberculosis Report, and accompanying global populations. who uses the original codes from the World Health Organization.
data("who")
```

+ `population.csv`: Population data of each country across time (Source: The World Bank).
```{r}
# A subset of data from the World Health Organization Global Tuberculosis Report, and accompanying global populations. who uses the original codes from the World Health Organization. 
data("population")
```

## Import

### 2.1. Preview the contents of `who.tsv` and `population.csv` by inspecting the files.
> Reference: https://bookdown.org/rwnahhas/IntroToR/inspect.html

```{r}
head(who)
head(population)
```


### 2.2. Import the data into tibbles named `who` and `population`
> Already performed and saved these datasets within local R environment from the Introduction stage above: as `who` and `population` respectively

### 2.3. Determine the number of rows and columns in each tibble.

```{r}
# dim(x) = check the current dimension of the provided dataset 
# to inspect and determine the number of observations (rows) and variables present (columns) on each dataset
dim(who) # [1]
dim(population) # [2]
```

```{r}
# lapply(x, y) = determine the types of each variable and generate its results as a list (arrays of characters)
# unlist(x) =  it converts the output list into a vector preview

unlist(lapply(who, class))
```

```{r}
unlist(lapply(population, class))
```

### 2.4. Check the summary of variable types for `population.csv`. Fix any anomalies and store the corrected data in `population2`.
```{r}
# Display the summary of variable types
summary(population)

# Fix any anomalies
population <- population %>%
  mutate(
    year = as.numeric(year),
    population = as.numeric(population),
    country = as.character(country)
  )

# Store the corrected data in population2
population2 <- population
population2
```

## Tidy Data

### `who.tsv` dataset

> **Description of Columns**
>
>> `country`: Country name.
>>
>> `iso2`: Two-digit country code.
>>
>> `iso3`: Three-digit country code.
>>
>> `year`: Year
>>
>> Variables like `new_ep_f014`:
>>
>>> `ep`: TB type (e.g., rel = relapse, ep = extrapulmonary).
>>> 
>>> `f`: Sex (e.g., f = female).
>>> 
>>> `014`: Age group (e.g., 0-14 years).

### In the context of Tuberculosis (TB), these abbreviations refer to different types of cases based on the method of diagnosis:

+ SP (Smear Positive): Cases where the TB bacteria are detected in a sputum smear test.
+ SN (Smear Negative): Cases where the TB bacteria are not detected in a sputum smear test, but TB is diagnosed through other methods.
+ EP (Extrapulmonary): Cases where TB affects parts of the body other than the lungs, such as the lymph nodes, bones, or kidneys.
+ REL (Relapse): Cases where a patient who was previously treated for TB and declared cured or treatment completed is diagnosed with TB again

#### 3.1.1 Identify the variables in the dataset.
```{r}
unlist(lapply(who, class))
```

#### 3.1.2 Perform a pivot operation to make the data tidy, storing the result in `who2`.
```{r}
who2 <- who %>%
  pivot_longer(cols = starts_with("new"),
               names_to = "key",
               values_to = "cases",
               values_drop_na = TRUE)
who2
```

#### 3.1.3 Separate values like `new_ep_f014` into components (e.g., `new`, `ep`, `f014`). Remove the column containing new, and store the result in `who3`.
```{r}
who3 <- who2 %>%
  separate(key, into = c("new", "type_sexage"), sep = "_", extra = "merge", fill = "right") %>%
  filter(!is.na(new) & !is.na(type_sexage)) %>%
  mutate(
    type_sexage = 
      if_else(
        condition = str_detect(new, "newrel"), 
        true = paste0("rel_", type_sexage), 
        false = type_sexage
        ),
    new = 
      if_else(
        condition = str_detect(new, "newrel"),
        true = "new",
        false = new
        )
  ) %>%
  separate(type_sexage, into=c("tuberculosis_type", "sexage"), sep = "_") %>%
  select(-new)
  

who3
```

####  3.1.4 Further separate values like `f014` into `f` and `014`, storing the result in `who_tidy`.
```{r}
who_tidy <- who3 %>%
  separate(sexage, into = c("sex", "age"), sep = 1) %>%
  separate(age, into = c("age_from", "age_until"), sep = -2) %>%
  mutate(
    age_from = as.numeric(age_from),  # Ensure age_from is numeric
    age_until = as.numeric(age_until), # Ensure age_until is numeric
    age_from = 
      if_else(
        condition = age_until == 65,  # Directly compare age_until with 65
        true = 65,
        false = age_from
      )
    )
who_tidy
```

### `population.csv` Dataset
#### 3.2.1 Identify the variables in this dataset.
```{r}
unlist(lapply(population2, class))
```

#### 3.2.2 Perform a pivot operation to tidy the data, storing the result in `population3`.
```{r}
population3 <- population2 %>%
  pivot_wider(names_from = year,
              values_from = population,
              names_prefix = "population_")
population3

# NOTE: PIVOTING WIDER the dataset population2 might be relevant to some data visualization which then stored as population3, however, no pivot_longer() operation that can be further done within population2, in contrast, after this code block, in order to properly perform left_join() between datasets who and population, the population2 is indeed the best tidy data for population already.
```


#### 3.2.3 Cast the population variable to an appropriate data type, storing the result in `population_tidy`.
```{r}
# population_tidy <- population3 %>%
#  mutate_at(vars(starts_with("population_")), as.numeric)

# answer for 3.2.3 is the - code block - comment above, however, we would rather use:
population_tidy <- population2 # this one!
```

## Join Datasets
#### 3.3.1 Identify the variable(s) required to join who_tidy and population_tidy.

```{r}
print("Variables in who_tidy data:")
unlist(lapply(who_tidy, class))
```

```{r}
print("Variables in population_tidy data:")
unlist(lapply(population_tidy, class))
```

<span style="color: red"> WE IDENTIFIED THAT ONLY ONE VARIABLE THAT CAN BE JOIN BETWEEN DATASETS, PERFORMING THE LEFT_JOIN FROM `who_tidy` TO `population_tidy` with variable `year` as the key reference. </span>

####  3.3.2 Rename columns as needed to align variable names between datasets.
```{r}
# No need to *rename* the mentioned columns since both datasets contain variable `year` already and as numeric datatype already
```

#### 3.3.3 Join the datasets into a tibble called `tuberculosis`.

```{r}
tuberculosis <- left_join(x = who_tidy, y = population_tidy, by = c("country", "year"))
tuberculosis
```
## Clean Up Data
#### 3.4.1 Remove unnecessary variables from `tuberculosis`.
#### 3.4.2 Filter out `NA` values
#### 3.4.3 Save the cleaned data back into `tuberculosis`.
```{r}
tuberculosis <- tuberculosis %>%
  select(-iso2, -iso3) %>%
  na.omit()
tuberculosis
```

## Data Manipulation
### 4.1 Determine the total TB cases among men and women in the 21st century in the United States. Identify which sex had more cases.
```{r}
# total_tuberculosis_case_USA_by_sex <-
tuberculosis %>%
  filter(
    country == "United States of America",
    year >= 2001
  ) %>%
  group_by(sex) %>%
  summarize(total_tubercolosis_cases_by_sex = sum(cases))
```
```{r}
print("The data summary above provides us the understanding that the United States of America [USA], since 2001 to 2013, had such many tubercolosis cases within male population than female population - about 1.68 males would have tubercolosis for every 1 female having this disease also (ratio 1.68:1) by then having total tubercolosis case by sex are as follows: 73,769 male, and 43,982 female within USA from 2001 - 2013")
```

### 4.2 Create a new variable, `cases_per_100k`, representing TB cases per 100,000 people by year, sex, age group, and TB type.
```{r}
tuberculosis <- tuberculosis %>%
  mutate(
    cases_per_100k = (cases / population) * 10**5
  )
```

### 4.3 Identify:

#### The country and year with the highest cases per 100k.
```{r}
tuberculosis %>%
  filter(cases_per_100k == max(cases_per_100k))
print("Highest Case of TB per 100k people: {Country: Samoa; Year: 2009} which signifies that very concerning amount of people would expected to get at least 601 TB cases for every 100,000 people considered within the population of Samoa")
```

#### The country and year with the lowest cases per 100k.
```{r}
tuberculosis %>%
  filter(cases_per_100k != 0) %>% # OUTLIERS  
  filter(cases_per_100k == min(cases_per_100k))
  
print("Lowest Case of TB per 100k people: {Country: Russian Federation; Year: 2000} which signifies that least concerning amount of people would even get at most 1 TB cases for every 200,000,000 people considered")
```

## Data Visualization
### 5.1 Plot the total cases per 100k as a function of year for China, India, and the United States:
```{r}
# x-axis: time of the year
# y-axis: total cases recorded per 100k people
tb_visualization_1 <- tuberculosis %>%
  filter(country %in% c("China", "India", "United States of America")) %>%
  group_by(country, year) %>%
  summarise(average_cases_per_100k = mean(cases_per_100k))

tb_visualization_1 %>%
  ggplot() +
  geom_line(mapping = aes(x = year, y = average_cases_per_100k, colour = country)) +
  geom_point(mapping = aes(x = year, y = average_cases_per_100k, colour = country)) +
  scale_y_log10()
```

```{r}
print("The figure above is the tubercolosis report from three distinct countries: China, India, and United States of America; the report has been done yearly particularly from 1995 to 2013. (1) China had some slow and steady consistent near 1 person of having tubercolosis for every 100k people. (2) India on the other hand, suffers from almost no cases in 1995 it has been logarithmictically outbreak to more than 4 people having TB cases for every 100k. Finally, (3) gradual improvement of slowstead down of average cases of TB per 100k within USA")
```

### 5.2 Compare distributions of total cases per 100k (summed over years, sexes, and TB types) across age groups:
```{r}
# Create a new column for age group labels
tuberculosis <- tuberculosis %>%
  mutate(age_group = paste(age_from, age_until, sep = " - "))

# Create a new column for age group labels
tuberculosis <- tuberculosis %>%
  mutate(age_group = paste(age_from, age_until, sep = " - "))

# 1. Overall total cases per 100k for all years vs age groups
tb_overall <- tuberculosis %>%
  group_by(age_group) %>%
  summarise(total_cases_per_100k = sum(cases_per_100k, na.rm = TRUE))

ggplot(tb_overall, aes(x = age_group, y = total_cases_per_100k)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  scale_y_log10() +
  labs(title = "Overall Total Cases per 100k for All Years vs Age Groups",
       x = "Age Group",
       y = "Total Cases per 100k (log scale)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print("The first figure (age group vs total cases per 100k: filled with sky blue bars) deploys a pattern of having extreme dispersion among each other's age groups: varies from at least 8600 - ages 0 to 14 - to at most 36000 - ages 25 - 34. The age group distribution is skewed from the right, as the age group starts 35-45 the total cases per 100k starts to fall down dramatically by at least 7000 for each proceeding age groups")

# 2. Sex total cases vs age groups
tb_sex <- tuberculosis %>%
  group_by(sex, age_group) %>%
  summarise(total_cases_per_100k = sum(cases_per_100k, na.rm = TRUE))

ggplot(tb_sex, aes(x = age_group, y = total_cases_per_100k, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_log10() +
  labs(title = "Sex Total Cases per 100k vs Age Groups",
       x = "Age Group",
       y = "Total Cases per 100k (log scale)",
       fill = "Sex") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print("The second figure (age group by sex vs total cases per 100k: filled with sky scarlet-cyan bars) implies the similar pattern on what the first figure offers but we were able to witness that regardless of age groups, more male experience to have tubercolosis than female by 1.68:1 ratio")

# 3. TB types vs age groups
tb_type <- tuberculosis %>%
  group_by(tuberculosis_type, age_group) %>%
  summarise(total_cases_per_100k = sum(cases_per_100k, na.rm = TRUE))

ggplot(tb_type, aes(x = age_group, y = total_cases_per_100k, fill = tuberculosis_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_y_log10() +
  labs(title = "TB Types Total Cases per 100k vs Age Groups",
       x = "Age Group",
       y = "Total Cases per 100k (log scale)",
       fill = "TB Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print("The third figure (age group by tubercolosis type vs total cases per 100k: filled with scarlet-green-cyan-purple bars) shows the distribution of each age group by each types of tubercolosis type they were experiencing, all of age groups detected that they have TB by Smear Test than other methods (SN vs SP cases). On the other hand, younger age groups tends to experience more TB cases that is affecting more than just their lungs themselves which considered as EP type of TB, while every 800 - 1000 people in any age group may experience TB REL that is if they were previously TB cured or treated but they have been officially diagnosed again")
```


Note: Tubercolosis Types:
+ SP (Smear Positive): Cases where the TB bacteria are detected in a sputum smear test.
+ SN (Smear Negative): Cases where the TB bacteria are not detected in a sputum smear test, but TB is diagnosed through other methods.
+ EP (Extrapulmonary): Cases where TB affects parts of the body other than the lungs, such as the lymph nodes, bones, or kidneys.
+ REL (Relapse): Cases where a patient who was previously treated for TB and declared cured or treatment completed is diagnosed with TB again

```{r}

```

#### 5.3 Create a plot to evaluate whether the number of cases per 100k in 2000 was related to a countryâ€™s population:

> Conclude based on the visualization.

```{r}
tuberculosis %>%
  filter(year == 2000, cases_per_100k != 0) %>%
  group_by(country) %>%
  ggplot(aes(x = population, y = cases_per_100k)) +
  geom_point(color = "gray") +
  geom_smooth(method = "loess", span = 0.5, se = FALSE, color = "red") +
  geom_smooth(method = "lm", se = FALSE, color = "cyan") +
  scale_x_log10(labels = scales::comma) +  # Format x-axis labels
  scale_y_log10(labels = scales::comma) +  # Format y-axis labels
  labs(
    title = "Total Cases per 100k versus Population in the year 2000",
    x = "World Population in 2000",
    y = "Cases per 100k"
  )
```
```{r}
print("The figure above demonstrates the population of each country in 2000 vs cases per 100k of tubercolosis resulted to each gray dots within the figure, it also shows two relationship fits one is linear regression - cyan line - and local regression - red line. Noticeably, the cyan line suggests an almost constant rate meaning, regardless on how much population increases, it does not significantly impacts the cases per 100k. Similarly, as we can see to the red line, the fluctuations within blue lines still observed, meaning the dispersion of data is clearly observed by the pattern between two variables in concern remains not influenced.")
```

